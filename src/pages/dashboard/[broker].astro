---
import List from "../../components/broker/list.astro";
import ListGroups from "../../layouts/broker/listGroups.astro";
import Layout from "../../layouts/layout.astro";
import Navbar from "../../layouts/navbar.astro";
import { isAuthenticated, getAuthToken } from "../../utils/auth.js";
import { postHolding } from "../../utils/postHolding.js";

export const prerender = false;

// Redirect ke login jika belum terautentikasi
if (!isAuthenticated(Astro.cookies)) {
  return Astro.redirect("/login", 302);
}

const { broker } = Astro.params as { broker: string };

function PnL (lot: any, avgPrice: any, lastPrice: any) {
    return (lastPrice - avgPrice) * lot * 100;
} 

let errorMessage = '';
let datas: any[] = [];

async function getDataHolding() {
  try {
    const apiUrl = import.meta.env.API_URL;
    const cookieHeader = Astro.request.headers.get("cookie") || "";
    const token = getAuthToken(Astro.cookies);

    const response = await fetch(`${apiUrl}/broker/holding/${broker}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        ...(cookieHeader ? { Cookie: cookieHeader } : {}),
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
      },
    });

    if (!response.ok) {
      // Return false untuk menandakan perlu redirect
      return false;
    }
    // console.log(response)

    const payload = await response.json();
    // console.log("Fetched holding payload:", payload);

    if (Array.isArray(payload?.data)) {
      const normalizedData = payload.data.map((item: any) => ({
        code: (item.stockCode ?? "Unknown").toString(),
        lot: Number(item.quantity ?? 0),
        AvgPrice: Number(item.averagePrice ?? 0),
        lastPrice: Number(item.lastPrice ?? 0),
      }));

      datas = [
        {
          message: payload.message ?? "Success",
          broker,
          cash: Number(payload.cash ?? 0),
          data: normalizedData,
        },
      ];
    } else {
      datas = [];
    }
    return true;
  } catch (error) {
    console.error("Login error:", error);
    errorMessage = "An error occurred. Please try again later.";
    return false;
  }
}

let dataFetched = await getDataHolding();

// Redirect jika fetch gagal atau broker tidak ditemukan
if (!dataFetched) {
  return Astro.redirect('/dashboard', 303);
}

if (Astro.request.method === "DELETE") {
  const brokerName = broker;
  const data = { brokerName };

  try {
    const apiUrl = import.meta.env.API_URL;
    const cookieHeader = Astro.request.headers.get("cookie") || "";
    const token = getAuthToken(Astro.cookies);

    const response = await fetch(`${apiUrl}/broker`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        ...(cookieHeader ? { Cookie: cookieHeader } : {}),
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
      },
      body: JSON.stringify(data)
    });

    if (!response.ok) {
      throw new Error(`Request failed with status ${response.status}`);
    } else {
      return Astro.redirect('/dashboard', 303);
    }

    // const payload = await response.json();
    // console.log("Fetched brokers payload:", response);
  } catch (error) {
    console.error("Delete error:", error);
    // errorMessage = "An error occurred. Please try again later.";
  }  
}

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const transaction = formData.get("transaction");

  if (transaction === 'buy') {
    const stockCode = (formData.get("code") ?? "").toString().toUpperCase();
    const price = Number(formData.get("price") ?? 0);
    const quantity = Number(formData.get("lot") ?? 0);

    const payload = {
      brokerName: broker,
      stockCode,
      quantity,
      price
    };

    const success = await postHolding(payload, 'buy', Astro.cookies, Astro.request);
    if (success) {
      return Astro.redirect(`/dashboard/${broker}`, 303);
    }
  } else if (transaction === 'sell') {
    const stockCode = (formData.get("code") ?? "").toString().toUpperCase();
    const price = Number(formData.get("price") ?? 0);
    const quantity = Number(formData.get("lot") ?? 0);

    const payload = {
      brokerName: broker,
      stockCode,
      quantity,
      price
    };

    const success = await postHolding(payload, 'sell', Astro.cookies, Astro.request);
    if (success) {
      return Astro.redirect(`/dashboard/${broker}`, 303);
    }
  } else if (transaction === 'deposit') {
    const cashBalance = formData.get("cash");
    const payload = { brokerName: broker, cashBalance };
    
    const success = await postHolding(payload, 'deposit', Astro.cookies, Astro.request);
    if (success) {
      console.log("success: ", success.data.message);
      return Astro.redirect(`/dashboard/${broker}`, 303);
    }
  } else if (transaction === 'withdraw') {
    const cashBalance = formData.get("cash");
    const payload = { brokerName: broker, cashBalance };
    
    const success = await postHolding(payload, 'withdraw', Astro.cookies, Astro.request);
    if (success) {
      return Astro.redirect(`/dashboard/${broker}`, 303);
    }
  } else {
    console.log("No valid transaction type selected.");
  }
}

const detail: any = datas.length > 0
  ? datas[0]
  : { broker, cash: 0, data: [] };

---
<Layout title={`Dashboard - ${broker}`}>
  {detail ? (
    <>
      <Navbar />
      <ListGroups data={detail} broker={broker}>
        {detail.data.map((item:any) => (
          <List code={item.code} lot={item.lot} AvgPrice={item.AvgPrice} lastPrice={item.lastPrice} PnL={PnL(item.lot, item.AvgPrice, item.lastPrice)} />
        ))}
      </ListGroups>
    </>
  ) : (
    <h1>Broker "{broker}" tidak ditemukan ğŸš«</h1>
  )}
</Layout>