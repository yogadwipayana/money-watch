---

const rupiah = (value: number) => {
  return new Intl.NumberFormat("id-ID", {
    style: "currency",
    currency: "IDR",
    minimumFractionDigits: 0, // tanpa decimal
    maximumFractionDigits: 0,
  }).format(value);
};

function hitungTotalPortofolio(portofolio: any) {
  const totalSaham = portofolio.data.reduce((acc: any, saham: any) => {
    return acc + (saham.lot * 100 * saham.lastPrice);
  }, 0);

  return portofolio.cash + totalSaham;
}

function PnL (portofolio: any) {
    const totalPnl = portofolio.data.reduce((acc: any, saham: any) => {
        return acc + ((saham.lastPrice - saham.AvgPrice) * saham.lot * 100);
    }, 0);
    
    return totalPnl;
}

const datas = Astro.props.data;
const broker = Astro.props.broker;

let errorMessage;
let successMessage ='done';

const pnl = PnL(datas);
const totalPortofolio = hitungTotalPortofolio(datas);
const profit = (pnl / (totalPortofolio - pnl)) * 100;
const invested = totalPortofolio - datas.cash;
const profitDisplay = profit.toFixed(2) + "%";

---

<main class="bg-blue-60 flex flex-col w-full h-[calc(90vh-4rem)] place-items-center">
    <div class="bg-amber-60 flex justify-end items-center w-full max-w-5xl h-auto pt-4 px-4 gap-3">
        <button id="addTransaction" class="bg-green-700 text-white px-4 py-1 rounded-lg">Add Transaction</button>
        <button id="removeBroker" data-broker={broker} class="bg-red-700 text-white px-4 py-1 rounded-lg">Remove {broker}</button>
    </div>
    <div class="bg-red-60 relative mt-5 max-w-6xl h-auto flex flex-col justify-center items-center ">
      <h1 class="bg-red-600 text-white w-full text-right px-2">{errorMessage}</h1>
      <!-- <h1 class="bg-green-600 text-white w-full text-right px-2">{successMessage}</h1> -->
        <span class="bg-amber-60 max-w-2xl h-auto grid grid-cols-1 md:grid-cols-2 my-5 gap-5  ">
            <div class="bg-gray-700 text-neutral-300 max-w-96 grid grid-cols-2 place-content-center p-2 gap-5 rounded-lg">
                <span>
                    <p>Portofolio</p>
                    <h1 class="text-2xl text-nowrap text-neutral-100 mb-2">{rupiah(totalPortofolio)}</h1>
                    <p>Return Today</p>
                </span>
                <span class="bg-red-60 flex flex-col justify-end text-start">
                    <p>Rp 0(0,00%)</p>
                </span>
            </div>
            <div class="bg-gray-700 text-neutral-300 grid grid-cols-2 p-2 place-content-center rounded-lg">
                <span>
                    <p>Cash</p>
                    <h1 id="cashSelect" class="text-md text-neutral-100">{rupiah(datas.cash)}</h1>

                    <p class="mt-2">P&L</p>
                    <h1 class="text-md text-neutral-100">{rupiah(pnl)}</h1>
                </span>
                <span>
                    <p>Invested</p>
                    <h1 class="text-md text-neutral-100">{rupiah(invested)}</h1>

                    <p class="mt-2">Profit</p>
                    <h1 class="text-md text-neutral-100">{profitDisplay}</h1>
                </span>
            </div>
        </span>
        <slot/>
    </div>


    <section id="addTransactionForm" class="hidden blur-none pt-20 absolute top-[-0px] bg-black/80 w-full justify-center items-center h-full">
    <div class="bg-gray-700 flex flex-col rounded-lg w-80 md:w-96 h-auto p-4">
        <h1 class="text-white text-lg">Add Transaction</h1>
        <form class="appearance-none flex flex-col mt-3 gap-1" action=`/dashboard/${broker}` method="POST">
        <label class="text-white" for="transaction">Transaction Type</label>
        <select class="bg-gray-300 appearance-none px-2 py-2 rounded-lg text-black border-1 border-gray-500 focus:outline-3 focus:outline-neutral-400 " name="transaction" id="transaction">
            <option value="">Select</option>
            <option value="buy">Buy</option>
            <option value="sell">Sell</option>
            <option value="deposit">Deposit</option>
            <option value="withdraw">Withdraw</option>
        </select>
        <div id="cashFlow" class="hidden grid grid-cols-1 gap-1 text-white">
            <label for="Cash">Cash</label>
            <input type="number" id="cash" name="cash" class="bg-gray-200 px-2 py-2 rounded-lg text-black border-1 border-gray-500 focus:outline-3 focus:outline-neutral-400 w-full" placeholder="500000" />
        </div>
        <div id="stockFlow" class="hidden grid grid-cols-2 gap-4 mt-2">
            <label for="code " class="text-white">Code</label>
            <input class="bg-gray-200 px-2 py-2 rounded-lg text-black border-1 border-gray-500 focus:outline-3 focus:outline-neutral-400" type="text" id="code" name="code" placeholder="BBCA" />
            <label for="price" class="text-white">Price</label>
            <input class="bg-gray-200 px-2 py-2 rounded-lg text-black border-1 border-gray-500 focus:outline-3 focus:outline-neutral-400" type="number" id="price" name="price" placeholder="0"/>
            <label for="lot" class="text-white flex flex-col justify-between">
                <span>Lot</span>
                <span id="cashLot" class="text-neutral-400"></span>
            </label>
            <input class="bg-gray-200 px-2 py-2 rounded-lg text-black border-1 border-gray-500 focus:outline-3 focus:outline-neutral-400" type="number" id="lot" name="lot" placeholder="0"/>
        </div>
        <div id="total" class="hidden grid grid-cols-2 text-white mt-3">
            <span>Total Order</span>
            <span id="totalOrder"></span>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <button id="cancelButton" class="bg-neutral-400 rounded-lg mt-3 py-1 text-white">Cancel</button>
          <button class="bg-green-700 rounded-lg mt-3 py-1 text-white" type="submit">Confirm</button>
        </div>
        </form>
    </div>
    </section>
</main>

<script is:inline>

  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('addTransaction');
    const form = document.getElementById('addTransactionForm');
    const cancelButton = document.getElementById('cancelButton');
    const removeBrokerButton = document.getElementById('removeBroker');

    if (btn) {
      btn.addEventListener('click', () => {
        form.classList.add('flex');
        form.classList.remove('hidden');
      });
      cancelButton.addEventListener('click', (e) => {
        e.preventDefault();
        form.classList.add('hidden');
        form.classList.remove('flex');
      });
    }

    const cashFlow = document.getElementById('cashFlow');
    const stockFlow = document.getElementById('stockFlow');
    const selectTransaction = document.getElementById('transaction');
    const cash = document.getElementById('cash');
    const totalOrder = document.getElementById('totalOrder');
    const total = document.getElementById('total');
    const cashSelect = document.getElementById('cashSelect').innerText;

    if (removeBrokerButton) {
      const brokerName = removeBrokerButton.getAttribute('data-broker') || '';
      removeBrokerButton.addEventListener('click', async () => {
        const confirmed = confirm(`Hapus broker "${brokerName}"?`);
        if (!confirmed) {
          return;
        }

        try {
          console.log(`/dashboard/${brokerName}`)
          const response = await fetch(`/dashboard/${brokerName}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            }
          });

          if (!response.ok) {
            const payload = await response.json().catch(() => ({}));
            throw new Error(payload?.message ?? 'Gagal menghapus broker.');
          }

          window.location.href = '/dashboard';
        } catch (error) {
          alert(error?.message ?? 'Terjadi kesalahan. Silakan coba lagi.');
        }
      });
    }

    cashFlow.classList.remove('grid');
    cashFlow.classList.add('hidden');

    if (selectTransaction) {
      selectTransaction.addEventListener('change', (e) => {
        const value = e.target.value;
        if (value === 'buy' || value === 'sell') {
          cashFlow.classList.add('hidden');
          stockFlow.classList.remove('hidden');
          if (value === 'buy') {
            document.getElementById('cashLot').innerText = `Cash ${cashSelect}`;
          } else {
            document.getElementById('cashLot').innerText = 'Lot ';
          }
          total.classList.remove('hidden');
        } else if (value === 'deposit' || value === 'withdraw') {
          cashFlow.classList.remove('hidden');
          stockFlow.classList.add('hidden');
          total.classList.remove('hidden');

        } else {
          cashFlow.classList.add('hidden');
          stockFlow.classList.add('hidden');
          total.classList.add('hidden');
        }

        if (cash && totalOrder) {
          cash.addEventListener('input', () => {
            totalOrder.innerText = `Rp ${cash.value}`;
      });
    }
      });
    }

  });
</script>

<style>
select {
  appearance: none;      
  -webkit-appearance: none;
  -moz-appearance: none;

  background: #d1d5dc url("data:image/svg+xml;utf8,<svg fill='black' height='12' viewBox='0 0 5 16' width='12' xmlns='http://www.w3.org/2000/svg'><path d='M 6 7 L 8 9 L 10 7 L 9 7 L 8 8 L 7 7 L 6 7'/></svg>") no-repeat right 0.75rem center;
  background-size: 5rem;
}
</style>